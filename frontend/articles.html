<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Статьи</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark" style="background-color: #000000;">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html" style="color: #D4AF37;">
                <i class="fas fa-blog me-2"></i>Админ-панель блога
            </a>
            <ul class="navbar-nav ms-auto">
                <li class="nav-item"><a class="nav-link active" href="articles.html" style="color: #D4AF37;"><i class="fas fa-newspaper me-1"></i>Статьи</a></li>
                <li class="nav-item"><a class="nav-link" href="comments.html"><i class="fas fa-comments me-1"></i>Комментарии</a></li>
                <li class="nav-item"><a class="nav-link" href="content-management.html"><i class="fas fa-tasks me-1"></i>Управление контентом</a></li>
                <li class="nav-item"><a class="nav-link" href="author-activity.html"><i class="fas fa-chart-bar me-1"></i>Активность авторов</a></li>
                <li class="nav-item"><a class="nav-link" href="statistics.html"><i class="fas fa-chart-pie me-1"></i>Статистика</a></li>
            </ul>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="card shadow-sm border-0">
            <div class="card-header" style="background-color: #000000; color: #D4AF37;">
                <h1 class="card-title mb-0">
                    <i class="fas fa-newspaper me-2"></i>Управление статьями
                </h1>
            </div>
            <div class="card-body">
                <div class="mb-4">
                    <h5 style="color: #000000;">Фильтры:</h5>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="statusFilter" class="form-label fw-bold" style="color: #000000;">Статус статьи:</label>
                            <select id="statusFilter" class="form-select">
                                <option value="">Все статусы</option>
                                <option value="Черновик">Черновик</option>
                                <option value="На модерации">На модерации</option>
                                <option value="Опубликовано">Опубликовано</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="authorFilter" class="form-label fw-bold" style="color: #000000;">Автор:</label>
                            <select id="authorFilter" class="form-select">
                                <option value="">Все авторы</option>
                                <!-- Авторы загружаются динамически -->
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="categoryFilter" class="form-label fw-bold" style="color: #000000;">Категория:</label>
                            <select id="categoryFilter" class="form-select">
                                <option value="">Все категории</option>
                                <!-- Категории загружаются динамически -->
                            </select>
                        </div>
                    </div>
                    <div class="d-flex gap-2">
                        <button onclick="applyFilters()" class="btn" style="background-color: #000000; color: #D4AF37; border: 1px solid #D4AF37;">
                            <i class="fas fa-filter me-1"></i>Применить фильтры
                        </button>
                        <button onclick="clearFilters()" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>Сбросить фильтры
                        </button>
                        <button onclick="location.reload()" class="btn" style="background-color: #000000; color: #40E0D0; border: 1px solid #40E0D0;">
                            <i class="fas fa-sync-alt me-1"></i>Обновить
                        </button>
                    </div>
                </div>

                <div id="loadingMessage" class="alert alert-info">
                    <i class="fas fa-spinner fa-spin me-2"></i>Загрузка статей...
                </div>
                
                <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>
                
                <div id="successContent" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-hover">
                            <thead style="background-color: #000000; color: #D4AF37;">
                                <tr>
                                    <th><i class="fas fa-heading me-1"></i>Заголовок</th>
                                    <th><i class="fas fa-user me-1"></i>Автор</th>
                                    <th><i class="fas fa-tag me-1"></i>Категория</th>
                                    <th><i class="fas fa-flag me-1"></i>Статус</th>
                                    <th><i class="fas fa-calendar me-1"></i>Дата создания</th>
                                    <th><i class="fas fa-edit me-1"></i>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable"></tbody>
                        </table>
                    </div>
                    <!-- Модальное окно редактирования статьи -->
                    <div class="modal fade" id="editArticleModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background-color: #000000; color: #D4AF37;">
                                    <h5 class="modal-title">Редактирование статьи</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editArticleForm">
                                        <input type="hidden" id="editArticleId">
                                        <div class="mb-3">
                                            <label for="editArticleStatus" class="form-label">Статус статьи</label>
                                            <select id="editArticleStatus" class="form-select">
                                                <option value="Черновик">Черновик</option>
                                                <option value="На модерации">На модерации</option>
                                                <option value="Опубликовано">Опубликовано</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                    <button type="button" class="btn" style="background-color: #000000; color: #D4AF37; border: 1px solid #D4AF37;" onclick="saveArticleChanges()">Сохранить</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Модальное окно полного редактирования статьи -->
                    <div class="modal fade" id="editArticleFullModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content">
                                <div class="modal-header" style="background-color: #000000; color: #40E0D0;">
                                    <h5 class="modal-title">Полное редактирование статьи</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editArticleFullForm">
                                        <input type="hidden" id="editArticleFullId">
                                        <div class="mb-3">
                                            <label for="editArticleTitle" class="form-label">Заголовок</label>
                                            <input type="text" class="form-control" id="editArticleTitle" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editArticleContent" class="form-label">Содержание</label>
                                            <textarea class="form-control" id="editArticleContent" rows="6" required></textarea>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="editArticleAuthor" class="form-label">Автор</label>
                                                <select class="form-select" id="editArticleAuthor" required>
                                                    <!-- Загружается динамически -->
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="editArticleCategory" class="form-label">Категория</label>
                                                <select class="form-select" id="editArticleCategory" required>
                                                    <!-- Загружается динамически -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editArticleFullStatus" class="form-label">Статус</label>
                                            <select id="editArticleFullStatus" class="form-select">
                                                <option value="Черновик">Черновик</option>
                                                <option value="На модерации">На модерации</option>
                                                <option value="Опубликовано">Опубликовано</option>
                                            </select>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                                    <button type="button" class="btn" style="background-color: #000000; color: #40E0D0; border: 1px solid #40E0D0;" onclick="saveArticleFullChanges()">Сохранить</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Модальное окно просмотра статьи -->
                    <div class="modal fade" id="viewArticleModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-xl">
                            <div class="modal-content">
                                <div class="modal-header" style="background-color: #000000; color: #40E0D0;">
                                    <h5 class="modal-title" id="viewArticleTitle"></h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <div id="viewArticleContent" style="white-space: pre-wrap; max-height: 500px; overflow-y: auto;"></div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="mt-5 py-3" style="background-color: #000000; color: #D4AF37;">
        <div class="container text-center">
             <p class="mb-0">2025 Админ-панель коллективного блога</p>
        </div>
    </footer>

    <script>
        let authors = [];
        let categories = [];
        
        async function loadAuthors() {
            try {
                const response = await fetch('http://localhost:8000/authors/');
                authors = await response.json();
                const select = document.getElementById('authorFilter');
                select.innerHTML = '<option value="">Все авторы</option>';
                authors.forEach(author => {
                    const option = document.createElement('option');
                    option.value = author._id;
                    option.textContent = author.full_name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка загрузки авторов:', error);
            }
        }
        
        async function loadCategories() {
            try {
                const response = await fetch('http://localhost:8000/categories/');
                categories = await response.json();
                const select = document.getElementById('categoryFilter');
                select.innerHTML = '<option value="">Все категории</option>';
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category._id;
                    option.textContent = category.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка загрузки категорий:', error);
            }
        }
        
        let currentArticleId = null;
        let articlesData = [];

        async function loadArticles() {
            const loadingElement = document.getElementById('loadingMessage');
            const errorElement = document.getElementById('errorMessage');
            const successElement = document.getElementById('successContent');
            
            loadingElement.style.display = 'block';
            errorElement.style.display = 'none';
            successElement.style.display = 'none';
            
            const statusFilter = document.getElementById('statusFilter').value;
            const authorFilter = document.getElementById('authorFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let url = 'http://localhost:8000/articles/';
            const params = [];
            
            if (statusFilter) params.push(`status=${encodeURIComponent(statusFilter)}`);
            if (authorFilter) params.push(`author_id=${encodeURIComponent(authorFilter)}`);
            if (categoryFilter) params.push(`category_id=${encodeURIComponent(categoryFilter)}`);
            
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Ошибка: ${response.status}`);
                
                articlesData = await response.json();
                
                loadingElement.style.display = 'none';
                renderArticlesTable(articlesData);
                successElement.style.display = 'block';
                
            } catch (error) {
                loadingElement.style.display = 'none';
                errorElement.style.display = 'block';
                errorElement.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>Ошибка загрузки: ${error.message}`;
            }
        }

        
        function renderArticlesTable(articles) {
            const tableBody = document.getElementById('dataTable');
            tableBody.innerHTML = '';
            
            if (articles.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>Статьи не найдены
                        </td>
                    </tr>
                `;
                return;
            }
            
            articles.forEach(article => {
                const row = document.createElement('tr');
                
                // Статус с цветом
                let statusClass = '';
                let statusStyle = '';
                switch(article.status) {
                    case 'Черновик': 
                        statusClass = 'badge';
                        statusStyle = 'background-color: #333333; color: white;';
                        break;
                    case 'На модерации': 
                        statusClass = 'badge';
                        statusStyle = 'background-color: #DC143C; color: white;';
                        break;
                    case 'Опубликовано': 
                        statusClass = 'badge';
                        statusStyle = 'background-color: #40E0D0; color: #000000;';
                        break;
                    default: 
                        statusClass = 'badge';
                        statusStyle = 'background-color: #000000; color: #D4AF37;';
                }
                
                row.innerHTML = `
                    <td class="fw-bold">${article.title}</td>
                    <td>${article.author_name || 'Неизвестно'}</td>
                    <td>${article.category_name || 'Неизвестно'}</td>
                    <td><span class="${statusClass}" style="${statusStyle}">${article.status}</span></td>
                    <td>${new Date(article.created_at).toLocaleDateString()}</td>
                    <td>
                        <button onclick="editArticle('${article._id}')" class="btn btn-sm" style="background-color: #000000; color: #D4AF37; border: 1px solid #D4AF37;" title="Изменить статус">
                            <i class="fas fa-flag"></i>
                        </button>
                        <button onclick="editArticleFull('${article._id}')" class="btn btn-sm ms-1" style="background-color: #000000; color: #40E0D0; border: 1px solid #40E0D0;" title="Полное редактирование">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="viewArticle('${article._id}')" class="btn btn-sm ms-1" style="background-color: #000000; color: white; border: 1px solid white;">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function applyFilters() {
            loadArticles();
        }
        
        function clearFilters() {
            document.getElementById('statusFilter').value = '';
            document.getElementById('authorFilter').value = '';
            document.getElementById('categoryFilter').value = '';
            loadArticles();
        }
        
        function editArticle(id) {
            currentArticleId = id;
            const article = articlesData.find(a => a._id === id);
            
            if (article) {
                document.getElementById('editArticleId').value = id;
                document.getElementById('editArticleStatus').value = article.status;
                
                const modal = new bootstrap.Modal(document.getElementById('editArticleModal'));
                modal.show();
            }
        }

        async function saveArticleChanges() {
            const articleId = document.getElementById('editArticleId').value;
            const newStatus = document.getElementById('editArticleStatus').value;
            
            try {
                // Сначала получаем текущие данные статьи
                const response = await fetch(`http://localhost:8000/articles/${articleId}`);
                if (!response.ok) throw new Error('Ошибка получения статьи');
                
                const article = await response.json();
                
                // Обновляем только статус
                article.status = newStatus;
                
                // Отправляем обновление
                const updateResponse = await fetch(`http://localhost:8000/articles/${articleId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(article)
                });
                
                if (updateResponse.ok) {
                    alert('Статус статьи обновлен!');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editArticleModal'));
                    modal.hide();
                    loadArticles(); // Перезагружаем таблицу
                } else {
                    throw new Error('Ошибка обновления статьи');
                }
                
            } catch (error) {
                alert('Ошибка: ' + error.message);
            }
        }
        
        async function viewArticle(id) {
            try {
                const response = await fetch(`http://localhost:8000/articles/${id}`);
                if (!response.ok) throw new Error('Ошибка получения статьи');
                
                const article = await response.json();
                
                document.getElementById('viewArticleTitle').textContent = article.title;
                document.getElementById('viewArticleContent').textContent = article.content;
                
                const modal = new bootstrap.Modal(document.getElementById('viewArticleModal'));
                modal.show();
                
            } catch (error) {
                alert('Ошибка загрузки статьи: ' + error.message);
            }
        }
        
        // Функция полного редактирования статьи
        async function editArticleFull(id) {
            currentArticleId = id;
            const article = articlesData.find(a => a._id === id);
            
            if (article) {
                // Заполняем форму
                document.getElementById('editArticleFullId').value = id;
                document.getElementById('editArticleTitle').value = article.title;
                document.getElementById('editArticleContent').value = article.content;
                document.getElementById('editArticleFullStatus').value = article.status;
                
                // Загружаем авторов и категории для выбора
                await loadAuthorsForEdit(article.author_id);
                await loadCategoriesForEdit(article.category_id);
                
                // Показываем модальное окно
                const modal = new bootstrap.Modal(document.getElementById('editArticleFullModal'));
                modal.show();
            }
        }

        async function loadAuthorsForEdit(currentAuthorId) {
            const select = document.getElementById('editArticleAuthor');
            select.innerHTML = '';
            
            try {
                const response = await fetch('http://localhost:8000/authors/');
                const authors = await response.json();
                
                authors.forEach(author => {
                    const option = document.createElement('option');
                    option.value = author._id;
                    option.textContent = author.full_name;
                    option.selected = (author._id === currentAuthorId);
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка загрузки авторов:', error);
            }
        }

        async function loadCategoriesForEdit(currentCategoryId) {
            const select = document.getElementById('editArticleCategory');
            select.innerHTML = '';
            
            try {
                const response = await fetch('http://localhost:8000/categories/');
                const categories = await response.json();
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category._id;
                    option.textContent = category.name;
                    option.selected = (category._id === currentCategoryId);
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Ошибка загрузки категорий:', error);
            }
        }

        async function saveArticleFullChanges() {
            const articleId = document.getElementById('editArticleFullId').value;
            const title = document.getElementById('editArticleTitle').value;
            const content = document.getElementById('editArticleContent').value;
            const authorId = document.getElementById('editArticleAuthor').value;
            const categoryId = document.getElementById('editArticleCategory').value;
            const status = document.getElementById('editArticleFullStatus').value;
            
            if (!title || !content || !authorId || !categoryId) {
                alert('Все поля обязательны для заполнения!');
                return;
            }
            
            try {
                const updateData = {
                    title: title,
                    content: content,
                    author_id: authorId,
                    category_id: categoryId,
                    status: status
                };
                
                const response = await fetch(`http://localhost:8000/articles/${articleId}/full`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        alert('Статья успешно обновлена!');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editArticleFullModal'));
                        modal.hide();
                        loadArticles(); // Перезагружаем таблицу
                    } else {
                        alert('Ошибка: ' + (result.error || 'Неизвестная ошибка'));
                    }
                } else {
                    const error = await response.json();
                    alert('Ошибка: ' + (error.error || 'Неизвестная ошибка'));
                }
                
            } catch (error) {
                alert('Ошибка сети: ' + error.message);
            }
        }

        // Загрузка при открытии страницы
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAuthors();
            await loadCategories();
            await loadArticles();
        });
    </script>
</body>
</html>